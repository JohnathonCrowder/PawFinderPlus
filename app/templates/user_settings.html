{% extends "base.html" %}

{% block title %}User Settings - DogBreederPlus{% endblock %}

{% block head %}
<script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">
<style>
    .settings-bg {
        background-image: url('https://www.transparenttextures.com/patterns/subtle-paw.png');
        background-color: #f0f4f8;
    }
    .settings-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .profile-picture {
        width: 150px;
        height: 150px;
        object-fit: cover;
        border-radius: 50%;
        border: 4px solid #0080ff;
    }
    .profile-picture-placeholder {
        width: 150px;
        height: 150px;
        background-color: #e0e0e0;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 3rem;
        color: #757575;
        border: 4px solid #0080ff;
    }
    .section-title {
        border-bottom: 2px solid #0080ff;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
        color: #0080ff;
    }
    .paw-button {
        background-color: #0080ff;
        color: white;
        border-radius: 25px;
        padding: 10px 25px;
        font-weight: bold;
        transition: all 0.3s ease;
    }
    .paw-button:hover {
        background-color: #0060c0;
        transform: scale(1.05);
    }
    .danger-button {
        background-color: #ff4136;
    }
    .danger-button:hover {
        background-color: #e60000;
    }
    .mapboxgl-ctrl-geocoder {
        width: 100%;
        max-width: none;
        font-size: 15px;
        line-height: 20px;
        font-family: inherit;
    }
</style>
{% endblock %}

{% block content %}
<div class="settings-bg min-h-screen py-12">
    <div class="container mx-auto px-4">
        <h1 class="text-4xl font-bold mb-8 text-center" style="color: #0080ff;">User Settings</h1>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="bg-{{ 'green' if category == 'success' else 'red' }}-100 border border-{{ 'green' if category == 'success' else 'red' }}-400 text-{{ 'green' if category == 'success' else 'red' }}-700 px-4 py-3 rounded relative mb-4" role="alert">
                        <span class="block sm:inline">{{ message }}</span>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <a href="{{ url_for('user_profile', username=current_user.username) }}" class="inline-block mb-4 bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition duration-300">
            <i class="fas fa-eye mr-2"></i>View Public Profile
        </a>

        <div class="settings-container p-8 mb-8">
            <h2 class="text-2xl font-bold mb-6 section-title">Profile Information</h2>
            <form action="{{ url_for('update_profile') }}" method="POST" enctype="multipart/form-data">
                <div class="flex flex-col md:flex-row">
                    <div class="md:w-1/3 mb-6 md:mb-0 flex flex-col items-center">
                        {% if user_data.has_profile_picture %}
                            <img src="{{ url_for('get_profile_picture', user_id=current_user.id) }}" 
                                 alt="Profile Picture" 
                                 class="profile-picture mb-4">
                        {% else %}
                            <div class="profile-picture-placeholder mb-4">
                                <i class="fas fa-user"></i>
                            </div>
                        {% endif %}
                        <input type="file" name="profile_picture" id="profile_picture" accept="image/*" class="mb-2">
                        {% if user_data.has_profile_picture %}
                            <button type="submit" form="remove_picture_form" class="text-red-500 underline mt-2">Remove Picture</button>
                        {% endif %}
                    </div>
                    <div class="md:w-2/3 md:pl-8">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="full_name">Full Name</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" 
                                   id="full_name" name="full_name" type="text" value="{{ user_data.full_name }}">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="address">Location</label>
                            <div id="geocoder" class="geocoder"></div>
                            <input type="hidden" id="address" name="address">
                            <input type="hidden" id="city" name="city">
                            <input type="hidden" id="state" name="state">
                            <input type="hidden" id="country" name="country">
                            <input type="hidden" id="latitude" name="latitude">
                            <input type="hidden" id="longitude" name="longitude">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="phone_number">Phone Number</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" 
                                   id="phone_number" name="phone_number" type="tel" value="{{ user_data.phone_number }}">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="website">Website</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" 
                                   id="website" name="website" type="text" pattern="https?://.+" 
                                   title="Please include http:// or https:// in the URL" value="{{ user_data.website }}">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="facebook">Facebook</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" 
                                   id="facebook" name="facebook" type="text" pattern="https?://.+" 
                                   title="Please include http:// or https:// in the URL" value="{{ user_data.facebook }}">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="instagram">Instagram</label>
                            <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" 
                                   id="instagram" name="instagram" type="text" pattern="https?://.+" 
                                   title="Please include http:// or https:// in the URL" value="{{ user_data.instagram }}">
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="bio">About Me</label>
                            <textarea class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-32" 
                                      id="bio" name="bio">{{ user_data.bio }}</textarea>
                        </div>
                        <div class="flex items-center justify-end">
                            <button class="paw-button" type="submit">
                                <i class="fas fa-paw mr-2"></i>Update Profile
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <div class="settings-container p-8 mb-8">
            <h2 class="text-2xl font-bold mb-6 section-title">Change Email</h2>
            <form action="{{ url_for('change_email') }}" method="POST">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="new_email">New Email</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" 
                           id="new_email" name="new_email" type="email" required>
                </div>
                <div class="flex items-center justify-end">
                    <button class="paw-button" type="submit">
                        <i class="fas fa-envelope mr-2"></i>Change Email
                    </button>
                </div>
            </form>
        </div>

        <div class="settings-container p-8 mb-8">
            <h2 class="text-2xl font-bold mb-6 section-title">Change Password</h2>
            <form action="{{ url_for('change_password') }}" method="POST">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="current_password">Current Password</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" 
                           id="current_password" name="current_password" type="password" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="new_password">New Password</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" 
                           id="new_password" name="new_password" type="password" required>
                </div>
                <div class="flex items-center justify-end">
                    <button class="paw-button" type="submit">
                        <i class="fas fa-lock mr-2"></i>Change Password
                    </button>
                </div>
            </form>
        </div>

        <div class="settings-container p-8">
            <h2 class="text-2xl font-bold mb-6 section-title text-red-600">Delete Account</h2>
            <p class="mb-4 text-red-600">Warning: This action cannot be undone. All your data will be permanently deleted.</p>
            <form action="{{ url_for('delete_account') }}" method="POST" onsubmit="return confirm('Are you sure you want to delete your account? This action cannot be undone.');">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="password_confirm">Confirm Password</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" 
                           id="password_confirm" name="password_confirm" type="password" required>
                </div>
                <div class="flex items-center justify-end">
                    <button class="paw-button danger-button" type="submit">
                        <i class="fas fa-trash-alt mr-2"></i>Delete Account
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<form id="remove_picture_form" action="{{ url_for('remove_profile_picture') }}" method="POST"></form>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiZGVmdGVybGFtYjYzIiwiYSI6ImNtMTg0b29kNTBzMnEyanB3YTl4bjl4eGQifQ.tjgnZiJbwQxeccVfe3oCKw';

var geocoder = new MapboxGeocoder({
    accessToken: mapboxgl.accessToken,
    types: 'address'
});

geocoder.addTo('#geocoder');

geocoder.on('result', function(e) {
    var result = e.result;
    document.getElementById('address').value = result.place_name;
    document.getElementById('latitude').value = result.center[1];
    document.getElementById('longitude').value = result.center[0];

    result.context.forEach(function(context) {
        if (context.id.startsWith('place')) {
            document.getElementById('city').value = context.text;
        } else if (context.id.startsWith('region')) {
            document.getElementById('state').value = context.text;
        } else if (context.id.startsWith('country')) {
            document.getElementById('country').value = context.text;
        }
    });
});

// Set initial value if available
if ("{{ user_data.address }}" !== "") {
    geocoder.setInput("{{ user_data.address }}");
}
</script>
{% endblock %}